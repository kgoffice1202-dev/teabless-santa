import React, { useState, useRef, useEffect, useMemo } from 'react';
import { 
  Gift, Heart, Sparkles, ArrowRight, Check, RefreshCw, 
  Snowflake, Star, Trees, Music, Coffee, Smile, 
  ExternalLink, Mail, MapPin, Headphones, PenTool, CheckCircle
} from 'lucide-react';

// êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ë°°í¬ URL (ê¸°ì¡´ ìœ ì§€)
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyjaYsCo2n-9SvIGFGggPv25VeIzBc2eB-AcvNtVt3XhNqpg6NC26z5PXifCPc51ZSnSA/exec";

// í†µí•© êµ¬ë§¤ ë§í¬
const SHOP_LINK = "https://www.qoo10.jp/shop/teabless_official";

// ì œí’ˆ ë°ì´í„° (í•œêµ­ì–´ ë²ˆì—­ ë° ë¡œì»¬ë¼ì´ì§•)
const PRODUCTS = [
  {
    id: 'lily-musk',
    name: 'ë¦´ë¦¬ ë¨¸ìŠ¤í¬ í™”ì´íŠ¸í‹°',
    items: 'ë¡œì…˜, ì›Œì‹œ, í•¸ë“œí¬ë¦¼',
    scent: 'ìˆœìˆ˜í•˜ê³  ë”°ìŠ¤í•œ ë¨¸ìŠ¤í¬ í–¥',
    desc: 'í•˜ì–€ ëˆˆì´ ì†Œë³µì´ ìŒ“ì¸ ì •ì› ê°™ì€ ìˆœìˆ˜í•¨. ë§‘ê³  ê¹¨ë—í•œ ì´ë¯¸ì§€ë¥¼ ê°€ì§„ ê·¸ ì‚¬ëŒì—ê²Œ ê²¨ìš¸ ì•„ì¹¨ ê°™ì€ íˆ¬ëª…í•œ í–¥ê¸°ë¥¼ ì„ ë¬¼í•˜ì„¸ìš”.',
    color: 'bg-slate-100 text-slate-800',
    accent: 'text-slate-500',
    tags: ['ìˆœìˆ˜', 'í¬ê·¼í•¨', 'ê²¨ìš¸ì•„ì¹¨'],
    link: SHOP_LINK,
    image: 'https://i.imgur.com/tH2AjAm.png'
  },
  {
    id: 'fig-peach',
    name: 'í”¼ê·¸ í”¼ì¹˜ ìš°ë¡±í‹°',
    items: 'ë¡œì…˜, ì›Œì‹œ',
    scent: 'ë‹¬ì½¤í•˜ê³  ìƒê¸° ë„˜ì¹˜ëŠ” ê³¼ì¼ í–¥',
    desc: 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤ íŒŒí‹°ì˜ ì„¤ë ˜ ê·¸ ìì²´! ì‚¬ë‘ìŠ¤ëŸ½ê³  ë§¤ë ¥ ë„˜ì¹˜ëŠ” ê·¸ ì‚¬ëŒì—ê²ŒëŠ” ë‹¬ì½¤í•œ ë³µìˆ­ì•„ì™€ ë¬´í™”ê³¼ í–¥ì´ ì°°ë–¡ì´ì—ìš”.',
    color: 'bg-pink-100 text-pink-900',
    accent: 'text-pink-500',
    tags: ['ëŸ¬ë¸”ë¦¬', 'ë‹¬ì½¤í•¨', 'íŒŒí‹°ë¬´ë“œ'],
    link: SHOP_LINK,
    image: 'https://i.imgur.com/4ZaANsL.png'
  },
  {
    id: 'sage-amber',
    name: 'ì„¸ì´ì§€ ì•°ë²„ í¼í”Œí‹°',
    items: 'ë¡œì…˜, ì›Œì‹œ',
    scent: 'ì°¨ë¶„í•˜ê³  ê¹Šì´ ìˆëŠ” ìš°ë”” í–¥',
    desc: 'ë”°ëœ»í•œ ë²½ë‚œë¡œ ê³ì—ì„œ ëŠë¼ëŠ” ì•ˆì‹. ëŠ˜ ì°¨ë¶„í•˜ê³  ì–´ë¥¸ìŠ¤ëŸ¬ìš´ ê·¸ ì‚¬ëŒì—ê²Œ ê¹Šì€ íë§ì˜ ì‹œê°„ì„ ì„ ë¬¼í•´ë³´ì„¸ìš”.',
    color: 'bg-purple-100 text-purple-900',
    accent: 'text-purple-600',
    tags: ['ìš°ì•„í•¨', 'ì‹ ë¹„ë¡œì›€', 'ê³ ìš”í•¨'],
    link: SHOP_LINK,
    image: 'https://i.imgur.com/WdKvuXf.png'
  },
  {
    id: 'blue-mellow',
    name: 'ë¸”ë£¨ ë©œë¡œìš°í‹°',
    items: 'ë¯¸ìŠ¤íŠ¸',
    scent: 'ë¶€ë“œëŸ½ê²Œ ê°ì‹¸ëŠ” ì½”íŠ¼ í–¥',
    desc: 'ê°“ ì„¸íƒí•œ ì´ë¶ˆ ì†ì— íŒŒë¬»íŒ ë“¯í•œ í–‰ë³µê°. ë°”ìœ ì¼ìƒì„ ë³´ë‚´ëŠ” ê·¸ ì‚¬ëŒì—ê²Œ â€˜íœ´ì‹â€™ ê°™ì€ ìˆœê°„ì„ ì „í•´ì£¼ì„¸ìš”.',
    color: 'bg-blue-100 text-blue-900',
    accent: 'text-blue-500',
    tags: ['í¸ì•ˆí•¨', 'ì²­ëŸ‰í•¨', 'ë¦´ë ‰ìŠ¤'],
    link: SHOP_LINK,
    image: 'https://i.imgur.com/NhFCBj5.png'
  },
  {
    id: 'floral-sweet',
    name: 'í”Œë¡œëŸ´ ìŠ¤ìœ„íŠ¸í‹°',
    items: 'ë¡œì…˜, ì›Œì‹œ, ë¯¸ìŠ¤íŠ¸',
    scent: 'ê½ƒë‹¤ë°œì„ í•œì•„ë¦„ ì•ˆì€ ë“¯í•œ í™”ë ¤í•œ í–¥',
    desc: 'ë‘ ì† ê°€ë“ ê½ƒë‹¤ë°œì„ ë°›ì•˜ì„ ë•Œì˜ ì„¤ë ˜. ì–¸ì œë‚˜ ì£¼ë³€ì„ ë°ê²Œ ë¹„ì¶°ì£¼ëŠ” ê³ ë§ˆìš´ ë¶„ê»˜ ê°ì‚¬ì˜ ë§ˆìŒì„ ë‹´ì•„ë³´ì„¸ìš”.',
    color: 'bg-rose-100 text-rose-900',
    accent: 'text-rose-500',
    tags: ['í•´í”¼', 'í™”ì‚¬í•¨', 'ê°ì‚¬'],
    link: SHOP_LINK,
    image: 'https://i.imgur.com/4ZaANsL.png'
  },
  {
    id: 'aqua-earl-grey',
    name: 'ì•„ì¿ ì•„ ì–¼ê·¸ë ˆì´í‹°',
    items: '250ml ë¡œì…˜, í˜ì´ì…œ ìŠ¤í¬ëŸ½, ë°”ë”” ìŠ¤í¬ëŸ½',
    scent: 'ìƒì¾Œí•˜ê³  íˆ¬ëª…í•œ í™ì°¨ í–¥',
    desc: 'ìˆ²ì†ì„ ê±°ë‹ˆëŠ” ë“¯í•œ ì²­ëŸ‰í•¨. ë¦¬í”„ë ˆì‹œê°€ í•„ìš”í•œ ê·¸ ì‚¬ëŒì—ê²Œ ê¸°ë¶„ ì¢‹ì€ ìˆ²ì˜ ë°”ëŒì„ ì „í•´ë³´ëŠ” ê±´ ì–´ë–¨ê¹Œìš”?',
    color: 'bg-teal-100 text-teal-900',
    accent: 'text-teal-600',
    tags: ['ìƒì¾Œí•¨', 'íœ´ì‹', 'ìˆ²ì˜í–¥ê¸°'],
    link: SHOP_LINK,
    image: 'https://i.imgur.com/6JLGgCw.png'
  },
  {
    id: 'musk-rose',
    name: 'ë¨¸ìŠ¤í¬ ë¡œì¦ˆí‹°',
    items: '250ml ë¡œì…˜',
    scent: 'ìš°ì•„í•˜ê³  ë¡œë§¨í‹±í•œ ì¥ë¯¸ í–¥',
    desc: 'ì˜í™” ì† í•œ ì¥ë©´ ê°™ì€ ë¡œë§¨í‹±í•œ ë¬´ë“œ. íŠ¹ë³„í•œ ë°¤, íŠ¹ë³„í•œ ê·¸ ì‚¬ëŒì—ê²Œ ë°”ì¹˜ëŠ” ìµœê³ ì˜ ì¥ë¯¸.',
    color: 'bg-red-50 text-red-900',
    accent: 'text-red-400',
    tags: ['ë¡œë§¨í‹±', 'ìš°ì•„í•¨', 'ì‚¬ë‘'],
    link: SHOP_LINK,
    image: 'https://i.imgur.com/Gsp5aXh.png'
  },
  {
    id: 'pear-green',
    name: 'í˜ì–´ ê·¸ë¦°í‹°',
    items: '250ml ë¡œì…˜',
    scent: 'ì‹±ê·¸ëŸ½ê³  ì´‰ì´‰í•œ ë°°(Pear) í–¥',
    desc: 'ê°“ ë”°ë‚¸ ê³¼ì‹¤ì˜ ì‹±ê·¸ëŸ¬ì›€! ì–¸ì œë‚˜ í™œê¸°ì°¨ê³  ì—ë„ˆì§€ ë„˜ì¹˜ëŠ” ê·¸ ì‚¬ëŒì—ê²Œ ë”± ì–´ìš¸ë ¤ìš”.',
    color: 'bg-green-100 text-green-900',
    accent: 'text-green-600',
    tags: ['í”„ë ˆì‰¬', 'ìƒí¼', 'ì—ë„ˆì§€'],
    link: SHOP_LINK,
    image: 'https://i.imgur.com/B6TtVzw.png'
  }
];

const QUESTIONS = [
  {
    id: 1,
    text: "ì˜¬í•´ í¬ë¦¬ìŠ¤ë§ˆìŠ¤,\nëˆ„êµ¬ì—ê²Œ í–‰ë³µì„ ì „í•˜ê³  ì‹¶ë‚˜ìš”?",
    type: 'choice',
    Icon: Gift,
    iconColor: "text-[#d63031]",
    options: [
      { text: "ì‚¬ë‘í•˜ëŠ” ì—°ì¸Â·íŒŒíŠ¸ë„ˆ", value: "lover" },
      { text: "ì†Œì¤‘í•œ ê°€ì¡±", value: "family" },
      { text: "ì•„ë¼ëŠ” ì¹œêµ¬Â·ë™ë£Œ", value: "friend" },
      { text: "ê³ ìƒí•œ ë‚˜ ìì‹ ", value: "me" }
    ]
  },
  {
    id: 2,
    text: "ê·¸ ì‚¬ëŒì˜ ì´ë¯¸ì§€ ì»¬ëŸ¬ëŠ”?",
    type: 'choice',
    Icon: Sparkles,
    iconColor: "text-[#e8c660]",
    options: [
      { text: "í¬ê·¼í•˜ê³  ë”°ëœ»í•œ íŒŒìŠ¤í…”í†¤", value: "warm" },
      { text: "ì„¸ë ¨ë˜ê³  ì‹œí¬í•œ ëª¨ë…¸í†¤", value: "chic" },
      { text: "ë°ê³  ëª…ë‘í•œ ë¹„ë¹„ë“œ ì»¬ëŸ¬", value: "bright" },
      { text: "ê¹¨ë—í•œ í™”ì´íŠ¸ & ë¸”ë£¨", value: "clean" }
    ]
  },
  {
    id: 3,
    text: "ê²¨ìš¸ ì—¬í–‰ì„ ë– ë‚œë‹¤ë©´ ì–´ë””ë¡œ?",
    type: 'choice',
    Icon: MapPin,
    iconColor: "text-green-400",
    options: [
      { text: "ì¡°ìš©í•œ ìˆ²ì† ì˜¤ë‘ë§‰", value: "nature" },
      { text: "ë°˜ì§ì´ëŠ” ë„ì‹œì˜ ì•¼ê²½", value: "city" },
      { text: "ë”°ëœ»í•œ ë‚¨ìª½ íœ´ì–‘ì§€", value: "resort" },
      { text: "ë…¸ê³¤ë…¸ê³¤í•œ ì˜¨ì²œ ì—¬í–‰", value: "history" }
    ]
  },
  {
    id: 4,
    text: "ì¶”ìš´ ë‚  í•¨ê»˜ ë§ˆì‹œê³  ì‹¶ì€ ìŒë£ŒëŠ”?",
    type: 'choice',
    Icon: Coffee,
    iconColor: "text-amber-600",
    options: [
      { text: "ë‹¬~ì½¤í•œ í•«ì´ˆì½”", value: "sweet" },
      { text: "í–¥ê¸‹í•œ í™ì°¨", value: "tea" },
      { text: "ê¹Šê³  ì§„í•œ ì»¤í”¼", value: "coffee" },
      { text: "ìƒí¼í•œ ìœ ìì°¨", value: "fresh" }
    ]
  },
  {
    id: 5,
    text: "ê·¸ ì‚¬ëŒì˜ ì„±ê²©ì€ ì–´ë–¤ê°€ìš”?",
    type: 'choice',
    Icon: Smile,
    iconColor: "text-yellow-400",
    options: [
      { text: "ì˜¨í™”í•˜ê³  ë‹¤ì •í•œ ì„±ê²©", value: "calm" },
      { text: "ì—´ì •ì ì´ê³  í™œë™ì ì¸ ì„±ê²©", value: "passion" },
      { text: "ì„¬ì„¸í•˜ê³  ì„¼ìŠ¤ ë„˜ì¹˜ëŠ” ì„±ê²©", value: "sensitive" },
      { text: "ë¶„ìœ„ê¸°ë¥¼ ë„ìš°ëŠ” ë¬´ë“œë©”ì´ì»¤", value: "funny" }
    ]
  },
  {
    id: 6,
    text: "íŒŒí‹° BGMìœ¼ë¡œ ì–´ìš¸ë¦¬ëŠ” ìŒì•…ì€?",
    type: 'choice',
    Icon: Headphones,
    iconColor: "text-pink-400",
    options: [
      { text: "ë¶„ìœ„ê¸° ìˆëŠ” ì¬ì¦ˆ", value: "jazz" },
      { text: "ìš°ì•„í•œ í´ë˜ì‹", value: "classic" },
      { text: "ì‹ ë‚˜ëŠ” ìºë¡¤ & íŒ", value: "pop" },
      { text: "ê°ì„±ì ì¸ ì–´ì¿ ìŠ¤í‹±", value: "acoustic" }
    ]
  },
  {
    id: 7,
    text: "ì„ ë¬¼í•˜ê³  ì‹¶ì€ ì‹œì¸„ì—ì´ì…˜ì€?",
    type: 'choice',
    Icon: Star,
    iconColor: "text-[#e8c660]",
    options: [
      { text: "ëˆˆ ë‚´ë¦¬ëŠ” ì°½ê°€ì—ì„œì˜ ê³ ìš”í•œ ì‹œê°„", value: "lily-musk" },
      { text: "ë²½ë‚œë¡œ ì•ì—ì„œ ë‚˜ëˆ„ëŠ” ëŒ€í™”", value: "sage-amber" },
      { text: "ì¼€ì´í¬ë¥¼ ë‘˜ëŸ¬ì‹¼ ì¦ê±°ìš´ íŒŒí‹°", value: "fig-peach" },
      { text: "ê½ƒí–¥ê¸° ê°€ë“í•œ ìš°ì•„í•œ í‹°íƒ€ì„", value: "floral-sweet" },
      { text: "ê°“ ì„¸íƒí•œ ì¹¨êµ¬ ì† ìƒì¾Œí•œ ì•„ì¹¨", value: "blue-mellow" },
      { text: "ë§‘ì€ ê³µê¸°ì˜ ìˆ²ê¸¸ ì‚°ì±…", value: "aqua-earl-grey" }
    ]
  }
];

export default function App() {
  const [step, setStep] = useState('intro');
  const [purchaseNumber, setPurchaseNumber] = useState('');
  const [answers, setAnswers] = useState({});
  const [currentQIdx, setCurrentQIdx] = useState(0);
  const [recommendedProduct, setRecommendedProduct] = useState(null);
  const [finalChoice, setFinalChoice] = useState(null);
  const [formData, setFormData] = useState({ story: '', preferredItem: '' });
  const [isSubmitting, setIsSubmitting] = useState(false);

  const clickSoundRef = useRef(null);

  const playClickSound = () => {
    if (clickSoundRef.current) {
      clickSoundRef.current.currentTime = 0;
      clickSoundRef.current.play().catch(error => console.log("Audio play failed:", error));
    }
  };

  useEffect(() => {
    window.scrollTo(0, 0);
  }, [step]);

  const resetApp = () => {
    playClickSound();
    setStep('intro');
    setPurchaseNumber('');
    setAnswers({});
    setCurrentQIdx(0);
    setRecommendedProduct(null);
    setFinalChoice(null);
    setFormData({ story: '', preferredItem: '' });
    setIsSubmitting(false);
  };

  const snowflakes = useMemo(() => Array.from({ length: 30 }).map((_, i) => ({
    id: i,
    left: `${Math.random() * 100}%`,
    animationDuration: `${Math.random() * 5 + 5}s`,
    opacity: Math.random() * 0.7 + 0.3,
    size: Math.random() * 15 + 10
  })), []);

  const decorations = useMemo(() => Array.from({ length: 12 }).map((_, i) => {
    const Icon = [Star, Gift][i % 2];
    return {
      id: i,
      Icon,
      left: `${Math.random() * 100}%`,
      top: `${Math.random() * 100}%`,
      animationDuration: `${Math.random() * 10 + 10}s`,
      opacity: Math.random() * 0.2 + 0.1,
      size: Math.random() * 20 + 10,
      color: i % 2 === 0 ? '#e8c660' : '#d63031'
    };
  }), []);

  const handlePurchaseSubmit = (e) => {
    e.preventDefault();
    playClickSound();
    if (purchaseNumber.length < 5) {
      const input = document.getElementById('purchase-input');
      if(input) {
        input.style.borderColor = 'red';
        setTimeout(() => input.style.borderColor = 'rgba(232, 198, 96, 0.4)', 1000);
      }
      return;
    }
    setStep('quiz');
  };

  const handleAnswer = (value) => {
    playClickSound();
    const newAnswers = { ...answers, [currentQIdx]: value };
    setAnswers(newAnswers);

    if (currentQIdx < QUESTIONS.length - 1) {
      setCurrentQIdx(currentQIdx + 1);
    } else {
      setStep('loading');
      calculateResult(newAnswers);
    }
  };

  const calculateResult = (finalAnswers) => {
    const key = finalAnswers[6];
    let product = PRODUCTS.find(p => p.id === key);
    
    if (!product) {
       const mood = finalAnswers[1];
       if (mood === 'warm') product = PRODUCTS.find(p => p.id === 'musk-rose');
       else if (mood === 'bright') product = PRODUCTS.find(p => p.id === 'pear-green');
       else product = PRODUCTS[0];
    }
    
    setTimeout(() => {
      setRecommendedProduct(product);
      setFinalChoice(product);
      setStep('result');
    }, 2500);
  };

  const handleFinalSubmit = async (e) => {
    e.preventDefault();
    playClickSound();
    setIsSubmitting(true);

    const giftString = `${finalChoice.name} (${formData.preferredItem || 'ëœë¤'})`;

    if (GOOGLE_SCRIPT_URL) {
        try {
            await fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    purchaseNumber: purchaseNumber,
                    gift: giftString,
                    story: formData.story
                })
            });
        } catch (error) {
            console.error("Error submitting to Google Sheets:", error);
        }
    }

    setTimeout(() => {
        setIsSubmitting(false);
        setStep('success');
    }, 1500);
  };

  const CurrentQuestionIcon = QUESTIONS[currentQIdx] ? QUESTIONS[currentQIdx].Icon : Gift;

  return (
    <div className="min-h-screen text-white font-sans relative bg-[#0f281e] overflow-x-hidden flex flex-col">
      <style>{`
        /* í•œêµ­ì–´ í°íŠ¸ ì¶”ê°€: Noto Sans KR, Gowun Batang(ëª…ì¡°), Jua(ì œëª©ìš©) */
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Chewy&family=Gowun+Batang:wght@400;700&family=Jua&family=Noto+Sans+KR:wght@300;400;500;700&display=swap');

        body {
          font-family: 'Noto Sans KR', sans-serif;
          background-color: #0f281e;
        }
        .font-dancing {
          font-family: 'Dancing Script', cursive;
        }
        .font-chewy {
          font-family: 'Chewy', cursive;
        }
        /* ê°ì„±ì ì¸ ëª…ì¡°ì²´ */
        .font-mincho {
          font-family: 'Gowun Batang', serif;
        }
        /* ê·€ì—¬ìš´ ì œëª©ìš© í°íŠ¸ */
        .font-jua {
            font-family: 'Jua', sans-serif;
        }
        
        .text-pretty {
          text-wrap: pretty;
          word-break: break-word;
          overflow-wrap: break-word;
        }
        
        @keyframes fall {
          0% { transform: translateY(-20px) rotate(0deg); }
          100% { transform: translateY(100vh) rotate(360deg); }
        }

        @keyframes float {
          0%, 100% { transform: translateY(0px); }
          50% { transform: translateY(-20px); }
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(232, 198, 96, 0.3);
            border-radius: 4px;
        }
        
        .no-scrollbar::-webkit-scrollbar {
          display: none;
        }
        .no-scrollbar {
          -ms-overflow-style: none;
          scrollbar-width: none;
        }

        .animate-fade-in {
            animation: fadeIn 0.8s ease-out forwards;
        }
        .animate-scale-in {
            animation: scaleIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
      `}</style>

      <audio ref={clickSoundRef} src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3" preload="auto" />

      {/* Background & Decor */}
      <div className="fixed inset-0 pointer-events-none opacity-30">
         <div className="absolute bottom-0 left-0 right-0 flex justify-between items-end px-4 text-[#1a4c3a]">
            <Trees size={120} strokeWidth={1} />
            <Trees size={180} strokeWidth={1} className="-mb-10" />
            <Trees size={100} strokeWidth={1} />
         </div>
      </div>

      <div className="fixed inset-0 pointer-events-none z-0">
        {decorations.map((deco) => (
          <div
            key={deco.id}
            className="absolute"
            style={{
              left: deco.left,
              top: deco.top,
              animation: `float ${deco.animationDuration} ease-in-out infinite`,
              opacity: deco.opacity,
              color: deco.color
            }}
          >
            <deco.Icon size={deco.size} />
          </div>
        ))}
      </div>

      <div className="fixed inset-0 pointer-events-none z-0">
        {snowflakes.map((flake) => (
          <div
            key={flake.id}
            className="absolute text-white/40"
            style={{
              left: flake.left,
              top: '-20px',
              animation: `fall ${flake.animationDuration} linear infinite`,
              opacity: flake.opacity,
              fontSize: `${flake.size}px`
            }}
          >
            â„
          </div>
        ))}
      </div>

      {/* Header Logo */}
      <div className="relative z-20 w-full text-center pt-8 pb-4 flex-none">
        <h1 className="text-4xl font-dancing font-bold tracking-widest text-[#e8c660] drop-shadow-md">TEABLESS</h1>
        <div className="flex justify-center items-center gap-2 text-xs text-[#e8c660]/90 mt-1 font-mincho font-bold tracking-widest">
            <Star size={10} fill="#e8c660" /> 
            <span>í‹°ë¸”ë ˆìŠ¤</span> 
            <Star size={10} fill="#e8c660" />
        </div>
      </div>

      <main className="relative z-10 w-full max-w-md mx-auto flex-1 flex flex-col items-center justify-center p-6 pb-12">
        
        {/* --- STEP: INTRO --- */}
        {step === 'intro' && (
          <div className="text-center space-y-6 animate-fade-in w-full flex flex-col items-center flex-1 justify-center">
            <div className="relative py-4 flex flex-col items-center">
              
              {/* Santa with blending effect */}
              <div className="relative mb-6 w-56 h-56 flex items-center justify-center">
                 <div className="absolute inset-0 bg-[#d63031]/30 blur-[60px] rounded-full animate-pulse"></div>
                 <div className="absolute inset-0 bg-[#e8c660]/10 blur-[40px] rounded-full mix-blend-screen"></div>

                 <img 
                   src="https://i.imgur.com/gfbvDNB.png" 
                   alt="Santa Teabless"
                   className="relative z-10 w-full h-full object-contain drop-shadow-2xl animate-float"
                   style={{ 
                       maskImage: 'linear-gradient(to bottom, black 60%, transparent 100%)',
                       WebkitMaskImage: 'linear-gradient(to bottom, black 60%, transparent 100%)'
                   }}
                 />

                 <div className="absolute inset-0 z-20 pointer-events-none">
                     <Sparkles className="absolute top-[20%] right-[20%] text-[#e8c660] animate-pulse opacity-80" size={16} />
                     <Star className="absolute top-[10%] left-[30%] text-white animate-twinkle opacity-60" size={10} />
                     <Snowflake className="absolute bottom-[20%] left-[20%] text-white/40 animate-spin-slow" size={14} />
                 </div>
              </div>

              <div className="relative z-10 flex flex-col items-center -mt-6 w-full">
                <h2 className="text-3xl font-extrabold leading-tight text-white drop-shadow-xl flex items-center justify-center gap-2 whitespace-nowrap font-jua">
                  <span className="text-[#d63031] font-chewy text-4xl transform -rotate-6 pt-1">Santa</span>
                  <span>ê°€ ë˜ì–´ë³´ì„¸ìš”!</span>
                </h2>
              </div>
            </div>
            
            <div className="bg-white/5 backdrop-blur-md p-6 rounded-2xl border border-white/10 shadow-lg w-full max-w-xs mx-auto">
              <p className="text-white/90 text-sm leading-7 text-pretty font-medium break-keep font-mincho">
                ì†Œì¤‘í•œ ì‚¬ëŒì„ ë– ì˜¬ë¦¬ë©°<br/>
                ê·¸ ì‚¬ëŒì—ê²Œ ê¼­ ë§ëŠ” ì„ ë¬¼ì„<br/>
                ê³¨ë¼ë³´ì‹œê² ì–´ìš”?<br/><br/>
                í‹°ë¸”ë ˆìŠ¤ê°€ ë‹¹ì‹ ì˜<br/>
                ë”°ëœ»í•œ ë§ˆìŒì„ ì „í•´ë“œë¦½ë‹ˆë‹¤.
              </p>
            </div>

            <button 
              onClick={() => { playClickSound(); setStep('input'); }}
              className="w-full max-w-xs group bg-[#d63031] hover:bg-[#ff7675] text-white px-8 py-4 rounded-2xl font-bold transition-all flex items-center justify-center gap-2 shadow-lg shadow-red-900/40 transform hover:-translate-y-1 mt-4"
            >
              ê¸°í”„íŠ¸ ë§¤ì¹­ ì‹œì‘í•˜ê¸°
              <ArrowRight size={20} className="group-hover:translate-x-1 transition-transform" />
            </button>
          </div>
        )}

        {/* --- STEP: INPUT --- */}
        {step === 'input' && (
          <div className="w-full max-w-xs space-y-8 text-center animate-fade-in flex-1 flex flex-col justify-center">
            <div className="space-y-3">
                <h3 className="text-2xl font-bold text-[#e8c660] drop-shadow-md font-jua">êµ¬ë§¤ ì¸ì¦</h3>
                <p className="text-sm text-white/80 leading-relaxed text-pretty">
                  ì£¼ë¬¸ ë‚´ì—­ì— ìˆëŠ”<br/>
                  <span className="bg-white/10 px-2 py-0.5 rounded text-[#e8c660] font-bold">ì£¼ë¬¸ ë²ˆí˜¸</span>ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”
                </p>
            </div>
            
            <form onSubmit={handlePurchaseSubmit} className="space-y-4">
              <div className="relative">
                <input 
                  id="purchase-input"
                  type="text" 
                  placeholder="ì˜ˆ) 20251225" 
                  className="w-full bg-white/5 border border-[#e8c660]/40 rounded-2xl px-4 py-4 text-center text-white placeholder-white/30 focus:outline-none focus:border-[#e8c660] focus:bg-white/10 transition-all backdrop-blur-sm text-lg tracking-wider"
                  value={purchaseNumber}
                  onChange={(e) => setPurchaseNumber(e.target.value)}
                />
              </div>
              <button 
                type="submit"
                className="w-full bg-[#1a4c3a] active:bg-[#e8c660] active:text-[#1a2e25] border border-[#e8c660]/50 text-[#e8c660] py-4 rounded-2xl transition-all font-bold shadow-lg"
              >
                í™•ì¸í•˜ê¸°
              </button>
            </form>
          </div>
        )}

        {/* --- STEP: QUIZ --- */}
        {step === 'quiz' && (
          <div key={currentQIdx} className="w-full max-w-sm space-y-6 animate-fade-in flex flex-col flex-1 justify-center py-4">
            <div className="w-full bg-white/10 h-1.5 rounded-full mb-2 overflow-hidden shrink-0">
                <div 
                    className="bg-[#e8c660] h-full transition-all duration-500 ease-out"
                    style={{ width: `${((currentQIdx + 1) / QUESTIONS.length) * 100}%` }}
                ></div>
            </div>

            <div className="flex justify-center mb-1 shrink-0">
                 <div className="bg-white/10 p-4 rounded-full backdrop-blur-md shadow-inner border border-white/5">
                    <CurrentQuestionIcon className={`w-8 h-8 ${QUESTIONS[currentQIdx].iconColor} mb-0`} />
                 </div>
            </div>

            <h3 className="text-xl font-bold text-center leading-relaxed text-pretty min-h-[4rem] flex items-center justify-center drop-shadow-md px-2 break-keep shrink-0 font-jua">
              {QUESTIONS[currentQIdx].text}
            </h3>

            <div className="grid grid-cols-1 gap-3 pt-2 w-full">
            {QUESTIONS[currentQIdx].options.map((opt, idx) => (
                <button
                key={idx}
                onClick={() => handleAnswer(opt.value)}
                className="w-full bg-white/5 active:bg-[#e8c660] active:text-[#1a2e25] active:scale-95 border border-white/10 p-4 rounded-2xl text-left transition-all flex items-center justify-between group backdrop-blur-sm shadow-sm md:hover:bg-[#e8c660] md:hover:text-[#1a2e25] md:hover:border-[#e8c660]"
                >
                <span className="font-medium">{opt.text}</span>
                <ArrowRight size={18} className="opacity-0 group-active:opacity-100 md:group-hover:opacity-100 transition-all transform group-active:translate-x-1 md:group-hover:translate-x-1" />
                </button>
            ))}
            </div>
            
            <div className="text-center text-xs text-white/30 mt-2 font-bold shrink-0">
               {currentQIdx + 1} / {QUESTIONS.length}
            </div>
          </div>
        )}

        {/* --- STEP: LOADING --- */}
        {step === 'loading' && (
          <div className="text-center space-y-6 animate-pulse px-6 flex-1 flex flex-col justify-center items-center">
            <div className="relative inline-block">
                <div className="absolute inset-0 bg-[#e8c660] blur-2xl opacity-20 rounded-full animate-pulse"></div>
                <Sparkles size={64} className="text-[#e8c660] relative z-10 animate-spin-slow" />
            </div>
            <p className="text-xl font-bold text-white leading-relaxed text-pretty font-mincho">
              ì†Œì¤‘í•œ ë¶„ì—ê²Œ ì–´ìš¸ë¦¬ëŠ”<br/>
              í–¥ê¸°ë¥¼ í¬ì¥í•˜ê³  ìˆì–´ìš”...
            </p>
          </div>
        )}

        {/* --- STEP: RESULT --- */}
        {step === 'result' && finalChoice && (
          <div className="w-full max-w-sm animate-fade-in pt-4 pb-20">
            <div className="text-center mb-6">
              <span className="bg-[#d63031] text-white px-4 py-1.5 rounded-full text-xs font-bold tracking-wider mb-4 inline-block shadow-md border border-white/10">SANTA'S PICK</span>
              <h3 className="text-2xl font-extrabold drop-shadow-md leading-relaxed text-pretty font-jua">
                 <span className="text-[#e8c660] border-b-2 border-[#e8c660]/50 pb-1 px-1 inline-block">
                   {QUESTIONS[0].options.find(o => o.value === answers[1])?.text || "ì†Œì¤‘í•œ ë¶„"}
                 </span>
                 ì„ ìœ„í•œ<br/>ì¶”ì²œ ì„ ë¬¼
              </h3>
            </div>

            {/* Recommended Card */}
            <div className={`bg-white/95 backdrop-blur-xl rounded-3xl p-6 text-slate-800 shadow-2xl relative overflow-hidden mb-6 transition-all group border-4 border-white/20`}>
              <a href={finalChoice.link} target="_blank" rel="noreferrer" className="block relative cursor-pointer group-hover:scale-[1.02] transition-transform duration-300">
                <div className="w-full aspect-square bg-slate-100 rounded-2xl mb-5 flex flex-col items-center justify-center text-slate-300 relative overflow-hidden border border-slate-200">
                    <img 
                        src={finalChoice.image} 
                        alt={finalChoice.name} 
                        className="w-full h-full object-cover" 
                        onError={(e) => {
                            e.target.onerror = null;
                            e.target.src = "https://placehold.co/400x400/e2e8f0/64748b?text=Teabless";
                        }}
                    />
                    <div className="absolute bottom-2 right-2 bg-black/50 text-white text-[10px] px-2 py-1 rounded-full flex items-center gap-1 backdrop-blur-sm">
                      <ExternalLink size={10} /> ì œí’ˆ ìƒì„¸ ë³´ê¸°
                    </div>
                </div>
              </a>
              
              <div className="relative z-10">
                <div className="flex justify-between items-start mb-2">
                    <h4 className={`text-xs font-bold uppercase tracking-wider py-1 px-2 rounded-md ${finalChoice.color} ${finalChoice.accent}`}>Best Match</h4>
                </div>
                
                <h2 className="text-xl font-extrabold mb-1 leading-tight text-slate-900 text-pretty break-words font-jua">{finalChoice.name}</h2>
                <p className="text-xs text-slate-500 mb-4 font-bold">{finalChoice.items}</p>

                <div className="flex gap-1.5 mb-5 flex-wrap">
                  {finalChoice.tags.map(tag => (
                    <span key={tag} className="text-[11px] bg-slate-100 border border-slate-200 text-slate-600 px-2.5 py-1 rounded-full font-bold">#{tag}</span>
                  ))}
                </div>
                
                <div className="bg-[#f8f9fa] p-4 rounded-2xl border border-slate-100 mb-4 w-full">
                    <p className="text-sm text-slate-700 leading-relaxed font-medium text-pretty break-words whitespace-normal font-mincho">
                    "{finalChoice.desc}"
                    </p>
                </div>

                <div className="flex items-center gap-3">
                    <div className="w-8 h-8 rounded-full bg-[#e8c660]/20 flex items-center justify-center shrink-0">
                        <Sparkles size={14} className="text-[#e8c660]" />
                    </div>
                    <div className="flex-1 min-w-0">
                        <p className="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-0.5">Scent Note</p>
                        <p className="text-sm font-bold text-slate-800 text-pretty break-words leading-tight">{finalChoice.scent}</p>
                    </div>
                </div>
              </div>
            </div>

            {/* Change Option */}
            <div className="bg-[#1a4c3a]/80 backdrop-blur-md rounded-2xl p-5 border border-[#e8c660]/20 mb-8 shadow-lg">
              <div className="flex items-center gap-2 mb-4">
                <RefreshCw size={18} className="text-[#e8c660]" />
                <h4 className="text-white font-bold text-sm">ë‹¤ë¥¸ í–¥ê¸°ë¡œ ë³€ê²½í•˜ì‹œê² ì–´ìš”?</h4>
              </div>
              
              <div className="space-y-2 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                {PRODUCTS.map((prod) => (
                  <button
                    key={prod.id}
                    onClick={() => { playClickSound(); setFinalChoice(prod); }}
                    className={`w-full p-3 rounded-xl text-left text-sm transition-all border flex items-center justify-between
                      ${finalChoice.id === prod.id 
                        ? 'bg-[#e8c660] border-[#e8c660] text-[#1a2e25] font-extrabold shadow-md transform scale-[1.02]' 
                        : 'bg-white/5 border-white/5 text-white/70 active:bg-white/10'
                      }`}
                  >
                    <div className="flex flex-col items-start gap-1 w-[85%]">
                        <span className={`text-[10px] uppercase tracking-wider w-full ${finalChoice.id === prod.id ? 'text-[#1a2e25]/80 font-bold' : 'text-[#e8c660] opacity-90'}`}>
                            {prod.scent}
                        </span>
                        <span className="font-medium text-sm text-left leading-tight text-pretty break-words w-full">{prod.name}</span>
                    </div>
                    {finalChoice.id === prod.id && <Check size={18} className="text-[#1a2e25] shrink-0" />}
                  </button>
                ))}
              </div>
            </div>

            {/* Button */}
            <div className="mt-8 mb-4 sticky bottom-6 z-30">
                <button 
                onClick={() => { playClickSound(); setStep('form'); }}
                className="w-full bg-[#d63031] text-white py-4 rounded-2xl font-bold text-lg active:bg-[#ff7675] active:scale-95 transition-all shadow-[0_0_25px_rgba(214,48,49,0.6)] flex items-center justify-center gap-2 border-2 border-white/10 md:hover:bg-[#ff7675]"
                >
                <Gift size={22} />
                ì´ ì„ ë¬¼ë¡œ í™•ì •í•˜ê¸°
                </button>
            </div>
          </div>
        )}

        {/* --- STEP: FORM --- */}
        {step === 'form' && (
          <div className="w-full max-w-xs animate-fade-in pt-4 pb-12 flex-1 flex flex-col justify-center">
             <div className="text-center mb-6 pt-2">
               <div className="inline-block p-4 bg-white/10 rounded-full mb-4 backdrop-blur-md border border-white/10">
                  <Mail size={40} className="text-[#e8c660]" />
               </div>
               <h3 className="text-2xl font-extrabold drop-shadow-md font-jua">ì‚¬ì—° ì ‘ìˆ˜</h3>
               <p className="text-sm text-white/80 mt-3 leading-relaxed text-pretty font-mincho">
                 <span className="text-[#e8c660] font-bold">"{finalChoice.name}"</span> ë¼ì¸ ì¤‘<br/>
                 ë°›ê³  ì‹¶ì€ ì œí’ˆê³¼ ê·¸ ì´ìœ ë¥¼ ë“¤ë ¤ì£¼ì„¸ìš”.
               </p>
               <div className="mt-4 bg-[#d63031]/20 border border-[#d63031] text-[#ff7675] text-xs font-bold px-3 py-1 rounded-full inline-block animate-pulse">
                 ğŸ ì •ì„±ê» ì‘ì„±í•˜ë©´ ë‹¹ì²¨ í™•ë¥  UP!
               </div>
             </div>

             <form onSubmit={handleFinalSubmit} className="space-y-5 bg-white/5 p-6 rounded-3xl border border-white/10 backdrop-blur-md shadow-xl">
               
               {/* Product Selection Input */}
               <div>
                 <label className="block text-xs font-bold text-[#e8c660] mb-2 ml-1 flex items-center gap-1">
                    <PenTool size={12}/> í¬ë§ ì œí’ˆ (ì„ íƒ)
                 </label>
                 <input 
                   type="text" 
                   placeholder="ì˜ˆ: ë¡œì…˜, ë°”ë””ì›Œì‹œ ë“±" 
                   className="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-[#e8c660] focus:bg-black/30 focus:outline-none transition-colors text-sm"
                   value={formData.preferredItem}
                   onChange={e => setFormData({...formData, preferredItem: e.target.value})}
                 />
                 <p className="text-[10px] text-white/40 mt-1 ml-1">
                    â€» í•´ë‹¹ í–¥ê¸° ë¼ì¸ì—… ì¤‘ ì›í•˜ì‹œëŠ” ì œí’ˆì´ ìˆë‹¤ë©´ ì ì–´ì£¼ì„¸ìš”. (ë¯¸ì…ë ¥ ì‹œ ëœë¤ ë°œì†¡)
                 </p>
               </div>

               <div>
                 <label className="block text-xs font-bold text-[#e8c660] mb-2 ml-1">ì„ ë¬¼í•˜ê³  ì‹¶ì€ ì´ìœ </label>
                 <textarea 
                   required
                   rows="6"
                   placeholder="ì˜ˆ: í•­ìƒ ê³ ìƒí•˜ì‹œëŠ” ì—„ë§ˆì—ê²Œ ê²¨ìš¸ ì¶”ìœ„ë¥¼ ìŠê²Œ í•´ì¤„ ë”°ëœ»í•œ í–¥ê¸°ë¥¼ ì„ ë¬¼í•´ë“œë¦¬ê³  ì‹¶ì–´ìš”..."
                   className="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-[#e8c660] focus:bg-black/30 focus:outline-none resize-none transition-colors leading-relaxed"
                   value={formData.story}
                   onChange={e => setFormData({...formData, story: e.target.value})}
                 />
               </div>
               
               <button 
                type="submit"
                disabled={isSubmitting}
                className="w-full mt-2 bg-[#e8c660] text-[#1a2e25] py-4 rounded-xl font-bold text-lg active:bg-white transition-colors shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 md:hover:bg-white"
               >
                 {isSubmitting ? (
                    <>
                        <RefreshCw className="animate-spin" size={20}/> ì „ì†¡ ì¤‘...
                    </>
                 ) : 'ì‚°íƒ€ì—ê²Œ ì‘ëª¨í•˜ê¸°'}
               </button>
             </form>
          </div>
        )}

        {/* --- STEP: SUCCESS --- */}
        {step === 'success' && (
          <div className="text-center animate-scale-in w-full max-w-sm flex-1 flex flex-col justify-center">
             <div className="relative inline-block mb-8">
                {/* Clean Circle Check Icon */}
                <div className="absolute inset-0 bg-[#e8c660] blur-2xl opacity-20 rounded-full animate-pulse"></div>
                <div className="relative z-10 flex items-center justify-center">
                    <CheckCircle size={80} className="text-[#e8c660] drop-shadow-lg" strokeWidth={1.5} />
                </div>
             </div>
             
             <h2 className="text-3xl font-extrabold text-[#e8c660] mb-4 drop-shadow-md font-jua">ì‹ ì²­ ì™„ë£Œ!</h2>
             <p className="text-white/90 leading-relaxed mb-10 text-base font-medium text-pretty font-mincho">
               ì´ë²¤íŠ¸ì— ì°¸ì—¬í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.<br/><br/>
               ë‹¹ì‹ ì˜ ë”°ëœ»í•œ ì‚¬ì—°ì´<br/>
               í¬ë¦¬ìŠ¤ë§ˆìŠ¤ì˜ ê¸°ì ì„<br/>
               ë§Œë“¤ì–´ ì¤„ ê±°ì˜ˆìš”.
             </p>

             <div className="bg-white/10 p-6 rounded-2xl border border-white/10 mb-10 text-sm text-left backdrop-blur-md shadow-lg relative overflow-hidden">
               <div className="absolute top-0 right-0 p-2 opacity-10">
                   <Gift size={60} />
               </div>
               <p className="text-[#e8c660] text-xs font-bold mb-4 uppercase tracking-wider border-b border-white/10 pb-2">Your Pick</p>
               <div className="space-y-3">
                   <div className="flex justify-between items-start border-b border-white/5 pb-2 mb-2">
                     <span className="text-white/60 font-medium mt-1 shrink-0">Scent.</span>
                     <span className="font-bold text-white text-right w-2/3 text-pretty">{finalChoice.name}</span>
                   </div>
                   <div className="flex justify-between items-start">
                     <span className="text-white/60 font-medium mt-1 shrink-0">Item.</span>
                     <span className="font-bold text-[#e8c660] text-right w-2/3 text-pretty">
                        {formData.preferredItem || 'ëœë¤'}
                     </span>
                   </div>
               </div>
             </div>

             <button 
               onClick={resetApp}
               className="text-white/50 text-sm hover:text-white font-bold transition-colors flex items-center justify-center gap-2 mx-auto pb-4 active:text-white"
             >
               <RefreshCw size={14} />
               ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°
             </button>
          </div>
        )}

      </main>
    </div>
  );
}
